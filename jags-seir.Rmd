---
title: "Stan_SIRD"
author: "Graham Casey Gibson"
date: "5/28/2020"
output: html_document
---
```{r}
# Load some required packages
##############
library(deSolve)

## Create an SIR function
sir <- function(time, state, parameters) {

  with(as.list(c(state, parameters)), {

    dS <- -beta * S * I
    dI <-  beta * S * I - gamma * I
    dR <-                 gamma * I

    return(list(c(dS, dI, dR)))
  })
}

### Set parameters
## Proportion in each compartment: Susceptible 0.999999, Infected 0.000001, Recovered 0
init       <- c(S = 1-1e-6, I = 1e-6, R = 0.0)
## beta: infection parameter; gamma: recovery parameter
parameters <- c(beta = 1.4247, gamma = 0.14286)
## Time frame
times      <- seq(0, 70, by = 1)

## Solve using ode (General Solver for Ordinary Differential Equations)
out <- ode(y = init, times = times, func = sir, parms = parameters)
## change to data frame
out <- as.data.frame(out)
## Delete time variable
out$time <- NULL
```





```{r}
# 5. MAKE THE SS MODEL a univariate random walk no
# covariates.
library(rjags)
model.loc = ("ss_model.txt")
jagsscript = cat("
model {  
   # priors on parameters
 
   gamma ~ dnorm(0,10)
   beta[1] ~ dnorm(0,10)
   SIR[1,1:3] ~ ddirch(dirch_init);
    predY[1] <- pop*SIR[1,2]
   Y[1] ~ dnorm(SIR[1,2], 100000);

   for(i in 2:N) {
      beta[i] ~ dnorm(beta[i-1],10000)
      SIR[i,1] <- max(SIR[i-1,1] - exp(beta[i])*SIR[i-1,1]*SIR[i-1,2],.00000000000000001)
      SIR[i,2] <- max(SIR[i-1,2] + exp(beta[i])*SIR[i-1,1]*SIR[i-1,2] -  exp(gamma)*SIR[i-1,2],.00000000000000001)
      SIR[i,3] <- max(SIR[i-1,3] +   exp(gamma)*SIR[i-1,2],.00000000000000001)
      predY[i] <- pop*SIR[i,2]
      Y[i] ~ dnorm(pop*SIR[i,2], 10000000); # Observation variation
   }
}  
", 
    file = model.loc)
covid <- read.csv("/Users/gcgibson/Downloads/jhu-incident.csv")

traits <- read.csv("/Users/gcgibson/Downloads/location_traits.csv")
ny_covid <- covid %>%
  dplyr::filter(location_abbreviation=='NY')

jags.data = list(dirch_init = c(100000000,.1,0),
                Y = c(ny_covid$value[1:15],rep(NA,10)),
                 N=15  +10,
                pop=300e6)
jags.params = c("predY","phi")
mod_ss = jags(jags.data, parameters.to.save = jags.params, model.file = model.loc, 
    n.chains = 3, n.burnin = 5000, n.thin = 1, n.iter = 10000, 
    DIC = TRUE)
library(MCMCvis)
sum_object <- MCMCsummary(mod_ss,params="predY", round = 2)# FITTING

#MCMCsummary(mod_ss,params="phi", round = 2)

```

```{r}
plot(sum_object$mean,type='l',col='red')
#lines(sum_object$`97.5%`,col='red')
lines(ny_covid$value[1:20])
abline(v=15)
#lines(sum_object$`2.5%`,col='red')
```

